name: Publish NuGet Package

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Package version (example: 0.1.0)"
        required: true
        type: string
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  publish:
    if: ${{ github.event_name == 'workflow_dispatch' || !contains(github.ref_name, '-') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Validate NuGet key
        shell: bash
        run: |
          if [ -z "${{ secrets.NUGET_API_KEY }}" ]; then
            echo "Missing repository secret NUGET_API_KEY"
            exit 1
          fi

      - name: Resolve package version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            version="${{ inputs.version }}"
          else
            version="${GITHUB_REF_NAME#v}"
          fi

          if [[ ! "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid version: $version"
            echo "Expected format: 0.1.0"
            exit 1
          fi

          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "Resolved package version: $version"

      - name: Restore
        run: dotnet restore CsvToolkit.sln

      - name: Pack
        run: |
          dotnet pack src/CsvToolkit.Core/CsvToolkit.Core.csproj \
            -c Release \
            --no-restore \
            -p:PackageVersion=${{ steps.version.outputs.version }} \
            -o artifacts

      - name: Push to NuGet
        run: |
          dotnet nuget push "artifacts/*.nupkg" \
            --api-key "${{ secrets.NUGET_API_KEY }}" \
            --source "https://api.nuget.org/v3/index.json" \
            --skip-duplicate
